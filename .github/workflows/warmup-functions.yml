name: Warmup Edge Functions

on:
  schedule:
    # 매 5분마다 실행 (cold start는 보통 5분 후 발생)
    - cron: '*/5 * * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  warmup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Warmup Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "Warming up Edge Functions..."

          # Supabase CLI로 warmup 함수 호출
          response=$(supabase functions invoke warmup \
            --project-ref $SUPABASE_PROJECT_REF \
            --method POST \
            --body '{}')

          echo "Response: $response"

          # JSON 파싱해서 success 체크
          if echo "$response" | grep -q '"success":true'; then
            echo "✅ Warmup successful"
            exit 0
          else
            echo "❌ Warmup failed"
            echo "$response"
            exit 1
          fi
